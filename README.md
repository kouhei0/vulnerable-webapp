脆弱性のあるウェブアプリケーションデモ
===

スタックオーバーラン脆弱性があるウェブサイトのデモ。

C 言語で記述した CGI を用いた簡単な掲示板のウェブサイトです。
とても多くの脆弱性を含みます。

動作させるには apache など CGI に対応した Web サーバが別途必要です。

### 動作環境

- Linux x86_64
- gcc
- apache 2.4

### 事前準備

スタックオーバーフローによる任意コード実行を有効にするには、いくつかのセキュリティ機構を無効化する必要があります。

- ASLR を無効にする
  - スタック内のコードにジャンプするため、スタックのアドレスを固定化する必要があります。
  - `sysctl -w kernel.randomize_va_space=0` を実行し、設定します。
- スタック内のデータを実行可能にする (Makefile で指定済み)
  - スタック内にコードを書き込み実行できるように XD bit の機能を無効にする必要があります。
  - リンク時に　`-z execstack` を指定します。
- stack canary を無効にする (任意)
  - スタックオーバーフローを検知する canary を無効化します。
  - しかし、このプログラムでは必須ではなく、stack canary を無効化する脆弱性があります。

### 存在する脆弱性

- XSS、HTML インジェクション
- バッファオーバーフロー脆弱性
- スタックオーバーフロー脆弱性
  - スタックオーバーフローによるリモートコード実行 (RCE) が可能です。

## 仕様

### ファイル

- cgi-bin/
  - cgi ファイル
  - view.cgi
    - トップページ。投稿を表示します。
  - post.cgi
    - 投稿を記録します。
  - dump.cgi
    - CGI の環境変数や入力を表示します。
    - デバッグ用で通常使用しません。
  - db.bin
    - 投稿を記録するデータベースファイルです。
- html/
  - 静的アセット置き場です。
  - global.css
    - 全体で使用する CSS です。
- Makefile
  - ビルド用の Makefile です。
- view.c
  - view.cgi のソースコードです。
- dump.c
  - dump.cgi のソースコードです。
- post.c
  - post.cgi のソースコードです。
- types.h
  - 共通の型定義ファイルです。
- exploit-exec-ps.s
  - post.cgi に注入するアセンブリコードです。
  - ps コマンドを実行します。
- exploit-exec-ps.txt
  - post.cgi に送信する POST フォームデータです。
  - exploit-exec-ps.s のコードを含みます。
  - `curl -d @exploit-exec-ps.txt http://localhost/cgi-bin/post.cgi` などで送信すると ps コマンドの実行結果がレスポンス二帰ってきます。ただし、最後の 8 バイトは環境毎に変わるので変更する必要があります。
- exploit-peek-passwd.s
  - post.cgi に注入するコードです。
  - /etc/passwd を盗み取ります。
- exploit-peek-passwd.txt
  - post.cgi に送信する POST フォームデータです。
  - exploit-exec-ps.txt の exploit-peek-passwd.s 版です。

### db.bin データ構造

31 個まで保持し、リング構造で古いデータを上書きする。

```
     |------------------------------
   0 | Index
     |------------------------------
  64 | Record 1
     |------------------------------
 128 | Record 2
     :
     :
 992 | Record 31
     |------------------------------
1024
```

#### インデックス

Idx に Record 番号を格納して管理。
未使用は 0。
中間レコード削除時は、Idx を書き換えてつめる。

```
   |------------------------------
 0 | Idx0 | Idx1 |  ..... | Idx 7 
 8 | Idx8 ...
16 |
24 | Idx24 | .... | Idx30 | Unused
32 | Unused
   :
   |------------------------------
64 
```

#### レコード


```
   |------------------------------
 0 | Timestamp (UNIX Epoch)
   |------------------------------
 8 | unused
   |------------------------------
16 | Name
24 |
   |------------------------------
32 | Body
40 |
48 |
56 |
   |------------------------------
64
```


